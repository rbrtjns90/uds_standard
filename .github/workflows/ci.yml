name: CI

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

jobs:
  build-and-test:
    name: Build & Test (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        include:
          - os: ubuntu-latest
            compiler: g++
          - os: macos-latest
            compiler: clang++

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies (Ubuntu)
      if: matrix.os == 'ubuntu-latest'
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential libgtest-dev
        # Build and install gtest
        cd /usr/src/gtest
        sudo cmake .
        sudo make
        sudo cp lib/*.a /usr/lib/ 2>/dev/null || sudo cp *.a /usr/lib/

    - name: Install dependencies (macOS)
      if: matrix.os == 'macos-latest'
      run: |
        brew install googletest

    - name: Create build directories
      run: mkdir -p build bin/tests

    - name: Build library
      run: make lib
      env:
        CXX: ${{ matrix.compiler }}

    - name: Build Google Tests
      run: make gtest
      env:
        CXX: ${{ matrix.compiler }}

    - name: Build Legacy Tests
      run: make tests
      env:
        CXX: ${{ matrix.compiler }}

    - name: Build Examples
      run: make examples
      env:
        CXX: ${{ matrix.compiler }}

    - name: Run Google Tests
      run: make run-gtest

    - name: Run Legacy Tests
      run: |
        echo "Running legacy tests..."
        failed=0
        passed=0
        for test in bin/tests/test_*; do
          if [ -f "$test" ]; then
            testname=$(basename $test)
            case "$testname" in
              fuzz_target_afl) continue ;;
            esac
            echo "Running: $testname"
            if $test > /dev/null 2>&1; then
              echo "  ✓ PASSED"
              passed=$((passed + 1))
            else
              echo "  ✗ FAILED"
              failed=$((failed + 1))
              # These tests have known CI timing issues - don't fail the build
              case "$testname" in
                test_async|test_timing)
                  echo "    (known CI timing issue - non-fatal)"
                  failed=$((failed - 1))
                  ;;
              esac
            fi
          fi
        done
        echo ""
        echo "Legacy tests: $passed passed, $failed failed"
        if [ $failed -gt 0 ]; then
          echo "ERROR: $failed test(s) failed"
          exit 1
        fi

  sanitizers:
    name: Sanitizer Checks
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential

    - name: Build with AddressSanitizer
      run: make asan
      continue-on-error: true

    - name: Build with UndefinedBehaviorSanitizer
      run: make ubsan
      continue-on-error: true

  static-analysis:
    name: Static Analysis
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install cppcheck
      run: |
        sudo apt-get update
        sudo apt-get install -y cppcheck

    - name: Run cppcheck
      run: |
        cppcheck --enable=warning,style,performance,portability \
                 --error-exitcode=0 \
                 --suppress=missingIncludeSystem \
                 --inline-suppr \
                 -I include \
                 src/ examples/ 2>&1 | tee cppcheck-report.txt
        
    - name: Upload cppcheck report
      uses: actions/upload-artifact@v4
      with:
        name: cppcheck-report
        path: cppcheck-report.txt

  coverage:
    name: Code Coverage
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential lcov

    - name: Build with coverage
      run: make coverage
      continue-on-error: true

    - name: Upload coverage report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: coverage-report
        path: coverage_html/
